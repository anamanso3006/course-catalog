name: Teste Unitário

on:
    workflow_dispatch: #Teste unitário

jobs:
    unit-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout do código
              uses: actions/checkout@v4
              
            - name: Set up Python
              uses: actions/setup-python@v3
              with:
                python-version: '3.9'

            - name: Set up dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y pkg-config libmysqlclient-dev

            - name: Install dependencies
              run: |
                pip install -r requirements.txt
                pip install pytest  # Ensure pytest is installed

            - name: Run tests
              run: |
                pytest

            - name: Config Docker
              uses: docker/setup-buildx-action@v2

            - name: Docker Build
              run: docker build -t ${{ vars.CONTAINER_IMAGE}}:teste .

            - name: Run Unit Test
              run: 
                docker run --rm -v ${{ github.workspace }}:/course-catalog \
                  ${{ vars.CONTAINER_IMAGE }}:teste sh -c "nosetests --with-xunit --with-coverage --cover-package=protect test_users.py"